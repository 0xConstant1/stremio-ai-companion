<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configure AI Companion - Stremio</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 2rem;
            min-height: 100vh;
            color: white;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 2rem;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            margin-bottom: 2rem;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
         input, select, textarea {
             width: 100%;
             padding: 0.75rem;
             border: 2px solid rgba(255,255,255,0.2);
             border-radius: 10px;
             background: rgba(255,255,255,0.1);
             color: white;
             font-size: 1rem;
             backdrop-filter: blur(10px);
             box-sizing: border-box;
         }
         .invalid {
             border-color: #f44336 !important;
             background: rgba(244,67,54,0.1) !important;
         }
         .error-text {
             color: #ffd2cf;
             font-size: 0.8rem;
             margin-top: 0.25rem;
             display: none;
         }
         .error-text.show {
             display: block;
         }        input::placeholder {
            color: rgba(255,255,255,0.6);
        }
        input:focus, select:focus {
            outline: none;
            border-color: rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.15);
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        .submit-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        .submit-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .result {
            margin-top: 2rem;
            padding: 1rem;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            display: none;
        }
        .result.success {
            border-left: 4px solid #4CAF50;
        }
        .result.error {
            border-left: 4px solid #f44336;
        }
        .url-box {
            background: rgba(0,0,0,0.2);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            word-break: break-all;
            font-family: monospace;
            font-size: 0.9rem;
        }
        .copy-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        .help-text {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 0.25rem;
        }
        .back-link {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            margin-bottom: 1rem;
            display: inline-block;
        }
        .back-link:hover {
            color: white;
        }
        .manifest-section {
            background: rgba(255,255,255,0.1);
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
        }
        .manifest-url {
            background: rgba(0,0,0,0.2);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            word-break: break-all;
            font-family: monospace;
            font-size: 0.9rem;
        }
    </style>
    <link rel="icon" type="image/png" sizes="32x32" href="/static/logo2_256.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/logo2_256.png">
</head>
<body>
    <div class="container">
        <img src="/static/logo2_256.png" alt="Stremio AI" style="width:72px;height:72px;border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,0.25);margin-bottom:1rem;display:block;margin-left:auto;margin-right:auto;">
        <a href="/" class="back-link">‚Üê Back to Home</a>
        <h1>{% if existing_config %}Reconfigure{% else %}Configure{% endif %} AI Companion</h1>
        {% if existing_config %}
        <p style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;">
            ‚úèÔ∏è Editing existing configuration. Make your changes below and save to generate a new manifest URL.
        </p>
        {% endif %}
        
        <form id="configForm">
            <div class="form-group">
                <label for="openai_base_url">LLM Provider</label>
                <select id="openai_base_url" name="openai_base_url">
                    {% set current_base = existing_config.openai_base_url if existing_config else settings.OPENAI_BASE_URL %}
                    {% set bases = {
                        'https://openrouter.ai/api/v1': 'OpenRouter',
                        'https://api.openai.com/v1': 'OpenAI',
                        'https://api.anthropic.com/v1': 'Anthropic',
                        'https://generativelanguage.googleapis.com/v1beta/openai/': 'Google Gemini (OpenAI Compatible)'
                    } %}
                    {% for url,label in bases.items() %}
                    <option value="{{ url }}" {% if current_base == url %}selected{% endif %}>{{ label }} ({{ url }})</option>
                    {% endfor %}
                    <option value="custom" {% if current_base not in bases %}selected{% endif %}>Custom</option>
                </select>
                <div class="help-text">Select a provider or choose Custom to enter URL</div>
                <input type="url" id="openai_base_url_custom" placeholder="Custom base URL (required for Custom)" value="{% if current_base not in bases %}{{ current_base }}{% endif %}" style="margin-top:0.5rem; display:{% if current_base not in bases %}block{% else %}none{% endif %};">
            </div>
            
            <div class="form-group">
                <label for="openai_api_key" id="api_key_label">OpenAI API Key *</label>
                <div style="position:relative;">
                    <input type="password" id="openai_api_key" name="openai_api_key" required 
                           placeholder="sk-..." value="{% if existing_config %}{{ existing_config.openai_api_key }}{% elif settings.OPENAI_API_KEY %}{{ settings.OPENAI_API_KEY }}{% endif %}" style="padding-right:2.5rem;">
                    <button type="button" class="copy-btn" onclick="toggleVisibility('openai_api_key', this)" aria-label="Toggle visibility" style="position:absolute; right:0.5rem; top:5%; height:28px; display:flex; align-items:center; justify-content:center; padding:0 0.5rem; border-radius:6px; font-size:0.9rem; line-height:1;">üëÅÔ∏è</button>
                </div>
                <div class="help-text" id="api_key_help">Your OpenAI API key for LLM movie suggestions</div>
            </div>
            
            <div class="form-group">
                <label for="model_name">Model</label>
                <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem; flex-wrap:wrap;">
                    <button type="button" id="fetch_models_btn" class="copy-btn">Fetch models</button>
                    <label class="checkbox-group" style="margin:0; display:flex; align-items:center; gap:0.4rem;">
                        <input type="checkbox" id="use_online_suffix">
                        <span>Use online (OpenRouter only)</span>
                    </label>
                </div>
                <select id="model_name" name="model_name" disabled style="width:100%;">
                    <option value="" disabled selected>Fetch models to select‚Ä¶</option>
                </select>
                <div id="model_spinner" class="help-text" style="display:none;">Loading models‚Ä¶</div>
                <div class="help-text">Searchable dropdown enabled after fetching models. You can still type a custom value.</div>
            </div>
            
            <div class="form-group">
                <label for="tmdb_read_access_token">TMDB Read Access Token *</label>
                <div style="position:relative;">
                    <input type="password" id="tmdb_read_access_token" name="tmdb_read_access_token" required 
                           placeholder="Your TMDB read access token" value="{% if existing_config %}{{ existing_config.tmdb_read_access_token }}{% elif settings.TMDB_READ_ACCESS_TOKEN %}{{ settings.TMDB_READ_ACCESS_TOKEN }}{% endif %}" style="padding-right:2.5rem;">
                    <button type="button" class="copy-btn" onclick="toggleVisibility('tmdb_read_access_token', this)" aria-label="Toggle visibility" style="position:absolute; right:0.5rem; top:5%; height:28px; display:flex; align-items:center; justify-content:center; padding:0 0.5rem; border-radius:6px; font-size:0.9rem; line-height:1;">üëÅÔ∏è</button>
                </div>
                <div class="help-text">Get your free read access token from <a href="https://www.themoviedb.org/settings/api" target="_blank" style="color: rgba(255,255,255,0.8);">TMDB API Settings</a></div>
                <div id="tmdb_error" class="error-text">This looks like a 32‚Äëchar API key. Please use your TMDB Read Access Token (JWT), not the API key.</div>
            </div>
            
            <div class="form-group">
                <label for="max_results">Max Results</label>
                <input type="number" id="max_results" name="max_results" 
                       value="{% if existing_config %}{{ existing_config.max_results }}{% else %}20{% endif %}" min="1" max="50">
                <div class="help-text">Maximum number of movies to return per search</div>
            </div>
            
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="include_adult" name="include_adult" {% if adult_flag %}checked{% endif %}>
                    <label for="include_adult">Include adult content in search results</label>
                </div>
                <div class="help-text">Allow adult/mature content to appear in movie search results</div>
            </div>
            

            
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="use_posterdb" name="use_posterdb" {% if existing_config and existing_config.use_posterdb %}checked{% endif %}>
                    <label for="use_posterdb">Use RPDB for custom artwork</label>
                </div>
            </div>
            
            <div class="form-group" id="posterdb_key_group" style="{% if existing_config and existing_config.use_posterdb %}display: block;{% else %}display: none;{% endif %}">
                <label for="posterdb_api_key">RPDB API Key</label>
                <div style="position:relative;">
                    <input type="password" id="posterdb_api_key" name="posterdb_api_key" 
                           placeholder="Your RPDB API key" value="{% if existing_config and existing_config.posterdb_api_key %}{{ existing_config.posterdb_api_key }}{% elif settings.RPDB_API_KEY %}{{ settings.RPDB_API_KEY }}{% endif %}" style="padding-right:2.5rem;">
                    <button type="button" class="copy-btn" onclick="toggleVisibility('posterdb_api_key', this)" aria-label="Toggle visibility" style="position:absolute; right:0.5rem; top:5%; height:28px; display:flex; align-items:center; justify-content:center; padding:0 0.5rem; border-radius:6px; font-size:0.9rem; line-height:1;">üëÅÔ∏è</button>
                </div>
                <div class="help-text">Optional: Enhanced movie posters from <a href="https://ratingposterdb.com" target="_blank" style="color: rgba(255,255,255,0.8);">RPDB</a></div>
            </div>
            
            <button type="submit" class="submit-btn">Generate Manifest URL</button>
        </form>
        
        <div id="result" class="result">
            {% include 'manifest_section.html' %}
            
            <div style="margin-top: 1.5rem; text-align: center;">
                <button class="copy-btn" onclick="openPreview()" style="background: rgba(76, 175, 80, 0.3); border-color: rgba(76, 175, 80, 0.5); padding: 0.75rem 1.5rem; font-size: 1rem;">
                    üé¨ Preview and Test
                </button>
            </div>
        </div>
        
        <div id="error" class="result error" style="display: none;">
            <h3>Error</h3>
            <p id="errorMessage"></p>
        </div>
    </div>

    <script>
        document.getElementById('use_posterdb').addEventListener('change', function() {
            const posterdbGroup = document.getElementById('posterdb_key_group');
            posterdbGroup.style.display = this.checked ? 'block' : 'none';
        });

         function validateTmdbToken() {
             const input = document.getElementById('tmdb_read_access_token');
             const err = document.getElementById('tmdb_error');
             const val = (input.value || '').trim();
             let ok = true;
             if (!val) {
                 input.classList.remove('invalid');
                 if (err) err.classList.remove('show');
                 return true;
             }
             if (val.length <= 60 || val.length < 150 || val.length === 32) {
                 input.classList.add('invalid');
                 if (err) err.classList.add('show');
                 ok = false;
             } else {
                 input.classList.remove('invalid');
                 if (err) err.classList.remove('show');
             }
             return ok;
         }

         document.getElementById('tmdb_read_access_token').addEventListener('input', validateTmdbToken);
         validateTmdbToken();

         document.getElementById('configForm').addEventListener('submit', async function(e) {            e.preventDefault();
            
            const submitBtn = document.querySelector('.submit-btn');
            const result = document.getElementById('result');
            const errorDiv = document.getElementById('error');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Generating...';
            result.style.display = 'none';
            errorDiv.style.display = 'none';
            
            const baseSel = document.getElementById('openai_base_url');
            const isOpenRouter = baseSel && baseSel.value === 'https://openrouter.ai/api/v1';
            const useOnline = document.getElementById('use_online_suffix')?.checked;
            const modelSel = document.getElementById('model_name');
            let modelValue = '';
            if (modelSel && modelSel.getAttribute('data-enhanced') === '1') {
                const input = modelSel.previousSibling && modelSel.previousSibling.querySelector('input');
                modelValue = input ? input.value.trim() : '';
            } else if (modelSel) {
                modelValue = (modelSel.value || '').trim();
            }
            if (isOpenRouter && useOnline && modelValue && !modelValue.endsWith(':online')) {
                modelValue += ':online';
            }
            let existingHidden = this.querySelector('input[name="model_name"]');
            if (existingHidden) existingHidden.remove();
            const hiddenModel = document.createElement('input');
            hiddenModel.type = 'hidden';
            hiddenModel.name = 'model_name';
            hiddenModel.value = modelValue || '';
            this.appendChild(hiddenModel);
            
            const formData = new FormData(this);
            
            try {
                const response = await fetch('/save-config', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    window.location.href = data.preview_url;
                } else {
                    throw new Error(data.detail || 'Configuration failed');
                }
            } catch (error) {
                const errorDiv = document.getElementById('error');
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.textContent = error.message;
                result.style.display = 'none';
                errorDiv.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Generate Manifest URL';
            }
        });

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }
        
        function openPreview() {
            if (window.previewUrl) {
                window.location.href = window.previewUrl;
            }
        }

        function toggleVisibility(inputId, btn) {
            const el = document.getElementById(inputId);
            if (!el) return;
            if (el.type === 'password') {
                el.type = 'text';
                btn.textContent = 'üôà';
            } else {
                el.type = 'password';
                btn.textContent = 'üëÅÔ∏è';
            }
        }

        
        
        
            document.getElementById('openai_base_url').addEventListener('change', function() {
                const custom = document.getElementById('openai_base_url_custom');
                const useOnline = document.getElementById('use_online_suffix');
                const label = document.getElementById('api_key_label');
                const help = document.getElementById('api_key_help');
                const providerMap = {
                    'https://openrouter.ai/api/v1': {name: 'OpenRouter', keyLabel: 'OpenRouter API Key *', help: 'Get your Key from https://openrouter.ai/keys'},
                    'https://api.openai.com/v1': {name: 'OpenAI', keyLabel: 'OpenAI API Key *', help: 'Get your Key from https://platform.openai.com/api-keys'},
                    'https://api.anthropic.com/v1': {name: 'Anthropic', keyLabel: 'Anthropic API Key *', help: 'Get your Key from https://console.anthropic.com/account/keys'},
                    'https://generativelanguage.googleapis.com/v1beta/openai/': {name: 'Google Gemini', keyLabel: 'Google Gemini Key *', help: 'Get your Key from https://aistudio.google.com/app/apikey'}
                };
                const selected = providerMap[this.value];
                if (label && selected) label.textContent = selected.keyLabel;
                if (help && selected) help.innerHTML = 'Get your Key from <a href="' + selected.help.split(' ').pop() + '" target="_blank" style="color: rgba(255,255,255,0.8);">' + selected.help.split(' ').pop() + '</a>';
                if (this.value === 'custom') {
                    custom.style.display = 'block';
                    if (label) label.textContent = 'LLM API Key *';
                    if (help) help.innerHTML = '';
                    if (useOnline) useOnline.parentElement.style.display = 'none';
                } else {
                    custom.style.display = 'none';
                    custom.value = '';
                    if (useOnline) useOnline.parentElement.style.display = (this.value === 'https://openrouter.ai/api/v1') ? 'flex' : 'none';
                }
            });

            function resetSearchableSelect(select) {
                if (select.getAttribute('data-enhanced') !== '1') return;
                const wrapper = select.previousSibling;
                if (wrapper && wrapper.querySelector && wrapper.querySelector('input')) {
                    wrapper.remove();
                }
                select.style.display = '';
                select.setAttribute('data-enhanced', '0');
            }

            (function initModelSelect() {
                const sel = document.getElementById('model_name');
                const initial = "{% if existing_config %}{{ existing_config.model_name }}{% else %}{% endif %}";
                if (sel && initial) {
                    resetSearchableSelect(sel);
                    sel.innerHTML = '';
                    const opt = document.createElement('option');
                    opt.value = initial;
                    opt.textContent = initial;
                    sel.appendChild(opt);
                    sel.disabled = false;
                    enhanceSearchableSelect(sel);
                    const inp = sel.previousSibling && sel.previousSibling.querySelector('input');
                    if (inp) inp.value = initial;
                }
                const baseSel = document.getElementById('openai_base_url');
                const useOnline = document.getElementById('use_online_suffix');
                if (useOnline && baseSel) {
                    useOnline.parentElement.style.display = (baseSel.value === 'https://openrouter.ai/api/v1') ? 'flex' : 'none';
                    const initialModel = initial || '';
                    useOnline.checked = initialModel.endsWith(':online');
                }
                if (!initial && sel) {
                    sel.disabled = false;
                    enhanceSearchableSelect(sel);
                }
            })();

            async function fetchModels() {
                const spinner = document.getElementById('model_spinner');
                const btn = document.getElementById('fetch_models_btn');
                const apiKey = document.getElementById('openai_api_key').value.trim();
                const baseSelect = document.getElementById('openai_base_url');
                const customBase = document.getElementById('openai_base_url_custom').value.trim();
                const baseUrl = baseSelect.value === 'custom' ? customBase : baseSelect.value;
                if (!apiKey) return;
                if (btn) { btn.disabled = true; btn.textContent = 'Fetching...'; }
                if (spinner) spinner.style.display = 'block';
                try {
                    const url = baseUrl.replace(/\/$/, '') + '/models';
                    const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${apiKey}` } });
                    let data = null;
                    try { data = await resp.json(); } catch (_) {}
                    if (!resp.ok) {
                        const code = data && (data.code || data.error?.code || data.status || data.statusCode || resp.status);
                        const msg = (data && (data.error?.message || data.message || data.error)) || resp.statusText || 'Failed to fetch models';
                        throw new Error(`${code || resp.status}: ${msg}`);
                    }
                    const select = document.getElementById('model_name');
                    const prevValue = (() => {
                        if (select.getAttribute('data-enhanced') === '1') {
                            const inp = select.previousSibling && select.previousSibling.querySelector('input');
                            return inp ? inp.value : '';
                        }
                        return select.value || '';
                    })();
                    resetSearchableSelect(select);
                    select.innerHTML = '';
                    let models = [];
                    if (Array.isArray(data)) models = data;
                    else if (Array.isArray(data.data)) models = data.data;
                    else if (Array.isArray(data.models)) models = data.models;
                    const unique = Array.from(new Set(models.map(m => typeof m === 'string' ? m : (m.id || m.name)).filter(Boolean)));
                    if (!unique.length) throw new Error('No models found');
                    const normalizedPrev = (prevValue || '').trim();
                    unique.forEach((id) => {
                        const opt = document.createElement('option');
                        opt.value = id;
                        opt.textContent = id;
                        if (normalizedPrev && id === normalizedPrev) opt.selected = true;
                        select.appendChild(opt);
                    });
                    if (normalizedPrev && !unique.includes(normalizedPrev)) {
                        const customOpt = document.createElement('option');
                        customOpt.value = normalizedPrev;
                        customOpt.textContent = normalizedPrev + ' (custom)';
                        customOpt.selected = true;
                        select.insertBefore(customOpt, select.firstChild);
                    } else if (!normalizedPrev) {
                        const placeholder = document.createElement('option');
                        placeholder.value = '';
                        placeholder.textContent = 'Select a model‚Ä¶';
                        placeholder.disabled = true;
                        placeholder.selected = true;
                        select.insertBefore(placeholder, select.firstChild);
                    }
                    select.disabled = false;
                    enhanceSearchableSelect(select);
                    const inp = select.previousSibling && select.previousSibling.querySelector('input');
                    if (inp) inp.value = normalizedPrev;
                    select.setAttribute('data-fetched', '1');
                } finally {
                    if (btn) { btn.disabled = false; btn.textContent = 'Fetch models'; }
                    if (spinner) spinner.style.display = 'none';
                }
            }

            document.getElementById('fetch_models_btn').addEventListener('click', async function() {
                const apiKey = document.getElementById('openai_api_key').value.trim();
                const baseSelect = document.getElementById('openai_base_url');
                const customBase = document.getElementById('openai_base_url_custom').value.trim();
                const baseUrl = baseSelect.value === 'custom' ? customBase : baseSelect.value;
                if (!apiKey) return;
                const btn = this;
                btn.disabled = true;
                btn.textContent = 'Fetching...';
                try {
                    const url = baseUrl.replace(/\/$/, '') + '/models';
                    const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${apiKey}` } });
                    let data = null;
                    try { data = await resp.json(); } catch (_) {}
                    if (!resp.ok) {
                        const code = data && (data.code || data.error?.code || data.status || data.statusCode || resp.status);
                        const msg = (data && (data.error?.message || data.message || data.error)) || resp.statusText || 'Failed to fetch models';
                        throw new Error(`${code || resp.status}: ${msg}`);
                    }
                    const select = document.getElementById('model_name');
                    const prevValue = (() => {
                        if (select.getAttribute('data-enhanced') === '1') {
                            const inp = select.previousSibling && select.previousSibling.querySelector('input');
                            return inp ? inp.value : '';
                        }
                        return select.value || '';
                    })();
                    resetSearchableSelect(select);
                    select.innerHTML = '';
                    let models = [];
                    if (Array.isArray(data)) models = data;
                    else if (Array.isArray(data.data)) models = data.data;
                    else if (Array.isArray(data.models)) models = data.models;
                    const unique = Array.from(new Set(models.map(m => typeof m === 'string' ? m : (m.id || m.name)).filter(Boolean)));
                    if (!unique.length) throw new Error('No models found');
                    let selectedIndex = -1;
                    const normalizedPrev = (prevValue || '').trim();
                    unique.forEach((id, idx) => {
                        const opt = document.createElement('option');
                        opt.value = id;
                        opt.textContent = id;
                        if (normalizedPrev && id === normalizedPrev) { opt.selected = true; selectedIndex = idx; }
                        select.appendChild(opt);
                    });
                    if (normalizedPrev && !unique.includes(normalizedPrev)) {
                        const customOpt = document.createElement('option');
                        customOpt.value = normalizedPrev;
                        customOpt.textContent = normalizedPrev + ' (custom)';
                        customOpt.selected = true;
                        select.insertBefore(customOpt, select.firstChild);
                    } else if (!normalizedPrev) {
                        const placeholder = document.createElement('option');
                        placeholder.value = '';
                        placeholder.textContent = 'Select a model‚Ä¶';
                        placeholder.disabled = true;
                        placeholder.selected = true;
                        select.insertBefore(placeholder, select.firstChild);
                    }
                    select.disabled = false;
                    enhanceSearchableSelect(select);
                    const inp = select.previousSibling && select.previousSibling.querySelector('input');
                    if (inp) inp.value = normalizedPrev;
                } catch (e) {
                    alert(e.message);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Fetch models';
                }
            });

            document.getElementById('configForm').addEventListener('submit', function() {
                const select = document.getElementById('openai_base_url');
                const customBase = document.getElementById('openai_base_url_custom').value.trim();
                if (select.value === 'custom') {
                    const hidden = document.createElement('input');
                    hidden.type = 'hidden';
                    hidden.name = 'openai_base_url';
                    hidden.value = customBase;
                    this.appendChild(hidden);
                }
                const modelSel = document.getElementById('model_name');
                let modelValue = '';
                if (modelSel && modelSel.getAttribute('data-enhanced') === '1') {
                    const input = modelSel.previousSibling && modelSel.previousSibling.querySelector('input');
                    modelValue = input ? input.value.trim() : '';
                } else if (modelSel) {
                    modelValue = (modelSel.value || '').trim();
                }
                const baseSelectEl = document.getElementById('openai_base_url');
                const isOpenRouter = baseSelectEl && baseSelectEl.value === 'https://openrouter.ai/api/v1';
                const useOnline = document.getElementById('use_online_suffix')?.checked;
                if (isOpenRouter && useOnline && modelValue && !modelValue.endsWith(':online')) {
                    modelValue = modelValue + ':online';
                }
                if (modelValue) {
                    const hiddenModel = document.createElement('input');
                    hiddenModel.type = 'hidden';
                    hiddenModel.name = 'model_name';
                    hiddenModel.value = modelValue;
                    this.appendChild(hiddenModel);
                }
            });

            function enhanceSearchableSelect(select) {
                if (select.getAttribute('data-enhanced') === '1') return;
                const wrapper = document.createElement('div');
                wrapper.style.position = 'relative';
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = 'Search or type custom model‚Ä¶';
                input.style.width = '100%';
                input.style.padding = '0.75rem';
                input.style.border = '2px solid rgba(255,255,255,0.2)';
                input.style.borderRadius = '10px';
                input.style.background = 'rgba(255,255,255,0.1)';
                input.style.color = 'white';
                input.style.fontSize = '1rem';
                input.style.backdropFilter = 'blur(10px)';
                const list = document.createElement('div');
                list.style.position = 'absolute';
                list.style.left = '0';
                list.style.right = '0';
                list.style.top = 'calc(100% + 4px)';
                list.style.maxHeight = '220px';
                list.style.overflowY = 'auto';
                list.style.background = 'rgba(0,0,0,0.6)';
                list.style.border = '1px solid rgba(255,255,255,0.25)';
                list.style.borderRadius = '10px';
                list.style.display = 'none';
                list.style.zIndex = '10';
                const options = Array.from(select.options).map(o => o.value).filter(Boolean);
                function render(filter) {
                    list.innerHTML = '';
                    const q = (filter || '').toLowerCase();
                    options.filter(v => !q || v.toLowerCase().includes(q)).slice(0, 200).forEach(v => {
                        const item = document.createElement('div');
                        item.textContent = v;
                        item.style.padding = '0.5rem 0.75rem';
                        item.style.cursor = 'pointer';
                        item.addEventListener('click', () => { input.value = v; list.style.display = 'none'; });
                        item.addEventListener('mouseover', () => item.style.background = 'rgba(255,255,255,0.08)');
                        item.addEventListener('mouseout', () => item.style.background = 'transparent');
                        list.appendChild(item);
                    });
                    list.style.display = 'block';
                }
                input.addEventListener('input', () => render(input.value));
                input.addEventListener('focus', () => render(input.value));
                document.addEventListener('click', (e) => { if (!wrapper.contains(e.target)) list.style.display = 'none'; });
                select.parentNode.insertBefore(wrapper, select);
                wrapper.appendChild(input);
                wrapper.appendChild(list);
                select.style.display = 'none';
                select.setAttribute('data-enhanced', '1');
                input.addEventListener('focus', async () => {
                    const alreadyFetched = select.getAttribute('data-fetched') === '1';
                    const hasOptions = Array.from(select.options).filter(o => o.value).length > 0;
                    if (!alreadyFetched && !hasOptions) await fetchModels();
                });
            }
        </script>
{% include '_footer.html' %}
</body>
</html>